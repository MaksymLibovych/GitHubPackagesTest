name: Publish NuGet Package

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up .NET 
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Check for existing NuGet source
      id: check-source
      run: 
        dotnet nuget list source | grep "github" || echo "not-found"

    - name: Add GitHub Packages NuGet source if not present
      if: steps.check-source.outputs.source != 'github'
      run: 
        dotnet nuget add source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/${{ github.actor }}/index.json"

    - name: Build project
      run: dotnet build --configuration Release

    - name: Pack NuGet package
      run: dotnet pack --configuration Release

    - name: Publish to GitHub Packages
      run: dotnet nuget push "TestConsole/bin/Release/*.nupkg" --api-key ${{ secrets.PAT_KEY }} --source "github" --skip-duplicate

    # - name: Set Git User Info
    #   run: 
    #     git config user.name "MaskymLibovych"
    #     git config user.email "makslibovich@gmail.com"

    - name: Create and Push Tag
      run: 
        VERSION=$(grep '<Version>' TestConsole/TestConsole.csproj | sed -e 's/<Version>\(.*\)<\/Version>/\1/')
        git tag -a "v$VERSION" -m "Tag for NuGet package version $VERSION"
        git push origin "v$VERSION"

        